
```{r options, include=FALSE}
opts_chunk$set(cache = TRUE)
```

Ohio Analyses
========================================================

Jillian Deines  
March 2014

This script analyses correlations among Ohio vegetation (historic and modern) and covariates (land use and environmental variables).

Analyses aim to describe presettlement vegetation in Ohio and examine relationships among
modern vegetation (using FIA data), historic vegetation, land use, and environmental variables.

#### Depends:
This script relies on output from the following scripts
* PLS_FIA_data_crunching.Rmd
* OH_Land_Use_Enviro_Var_processing.Rmd

#### Inputs:
* OHcountyLandCover.csv
* OH_EnviroVarCountySummary.csv
* OH_county_centroids_projected.csv 
* OHCompCleanPLS_percent.csv
* OHCompCleanFIA_percent.csv

#### Crunching:
* Aggregate land use classes
* Basic correlation matrices between county composition (FIA/PLS) and 1) environmental variables and 2) land use
* 

#### Outputs:
* OHCountyLandCover_aggregated.csv
* 

Working directory and packages
------------------------------
This assumes you have the file 'CleanCodeAndData' set as your working directory

```{r setup,message=FALSE}
setwd('C:/Users/deinesji/Dropbox/Dan_Williams/CleanCodeAndData')
library(ecodist)
library(corrplot)
library(RColorBrewer)
```


Correlations
--------------------------
PLS, FIA, environmental variables, and land use summaries are analyzed for correlations.  
* Proportional species composition data is arc sine square root transformed

**Note:** In previous versions of this script prior to Jill's pre-publication cleaning effort, there was a typo in the land use/composition correlations where the correlation between land use and PLS composition was stored as the variable 'fia.land', and vice versa. **Thus the patterns between land use and composition previously described in Dan's thesis version are reversed**. The number of the correlations differs due to data cleaning, but the pattern of strong/weak and positive/negative correlations is reversed.

```{r Correlations}
setwd('C:/Users/deinesji/Dropbox/Dan_Williams/CleanCodeAndData')

# read in data
pls <- read.csv("R output/OHCompCleanPLS_percent.csv")
fia <- read.csv("R Output/OHCompCleanFIA_percent.csv")
envar <- read.csv("R output/OH_EnviroVarCountySummary.csv")
landuse <- read.csv("R Output/OHCountyLandCover_aggregated_nmds.csv")
centroids <- read.csv("R output/OH_county_centroids_projected.csv") 

# subset enviro and land use to 27 data counties, add coords
envar2   <- merge(centroids, envar, by.x = "ID", by.y = "countyID", all.y = FALSE)
landuse2 <- merge(centroids, landuse, by.x = "ID", by.y = "Polygon", all.y = FALSE)

# arcsine squareroot transform proportional data (land use, pls, fia)
pls[,3:17]     <- asin(sqrt(pls[,3:17]))		
fia[,3:17]     <- asin(sqrt(fia[,3:17]))	
landuse2[,5:14] <- asin(sqrt(landuse2[,5:14])) 

# correlations: composition vs enviro, landuse 
plsEnvCor <-cor(envar2[,5:11], pls[,3:17])	
fiaEnvCor <-cor(envar2[,5:11], fia[,3:17])	
#cor(OHenvar3[,3:9], OHenvar3[,11:20])	# environ variables vs land use	
plsLandCor <- cor(landuse2[,5:14], pls[,3:17])	
fiaLandCor <- cor(landuse2[,5:14], fia[,3:17])	
```

### Correlation Plots
Needed: Nicer axis labels, significance indication?
```{r CorrPlots, echo=FALSE}
#pls/environmental variables
corrplot(plsEnvCor, method="color", addCoef.col="black", title="PLS-Enviroment", tl.col="black", 
  col=colorRampPalette(c("darkmagenta", "white", "darkgreen"))(200))
#fia/enviro
corrplot(fiaEnvCor, method="color", addCoef.col="black", title="FIA-Environment", tl.col="black", 
  col=colorRampPalette(c("darkmagenta", "white", "darkgreen"))(200))

#pls/land use
corrplot(plsLandCor, method="color", addCoef.col="black", title="PLS-Land Use", tl.col="black", 
  col=colorRampPalette(c("darkmagenta", "white", "darkorange2"))(200))
#fia/land use
corrplot(fiaLandCor, method="color", addCoef.col="black", title="FIA-Land Use", tl.col="black", 
	col=colorRampPalette(c("darkmagenta", "white", "darkorange2"))(200))
```


Mantel Tests
---------------------------

Other thoughts for Alex's notes: 
* This is areal/zonal data (vs points or continuous)
* Proximity: currently use county centroids in some fashion...but whaat about common boundary?

 Mantel tests? 1000 permutations seems standard??
### Load Data and Get Distance Matrices

```{r Mantels_loadData}
setwd('C:/Users/deinesji/Dropbox/Dan_Williams/CleanCodeAndData')

pls <- read.csv("R output/OHCompCleanPLS_percent.csv")
fia <- read.csv("R Output/OHCompCleanFIA_percent.csv")
envar <- read.csv("R output/OH_EnviroVarCountySummary.csv")
landuse <- read.csv("R Output/OHCountyLandCover_aggregated_nmds.csv")
centroids <- read.csv("R output/OH_county_centroids_projected.csv") 

# subset enviro and land use to 27 data counties, add coords
envar2   <- merge(centroids, envar, by.x = "ID", by.y = "countyID", all.y = FALSE)
landuse2 <- merge(centroids, landuse, by.x = "ID", by.y = "Polygon", all.y = FALSE)

# arcsine squareroot transform proportional data (land use, pls, fia)
pls[,3:17]     <- asin(sqrt(pls[,3:17]))  	
fia[,3:17]     <- asin(sqrt(fia[,3:17]))	
landuse2[,5:14] <- asin(sqrt(landuse2[,5:14])) 


# lat/long coords - note the indexing is wrong in OHAnalysesV3.r
county.cent <- read.csv("C:/Users/deinesji/Dropbox/Dan_Williams/OhioRGIS-Old_code_data/R output/OHCountyPLScentroids.csv") 
# extract county ID (ID), longitude (X.1), latitude (Y)
latlong <- county.cent[,c(4,2,3)]



# calculate distance between centroid locations

```

### Big Picture: Enviroment/climate vs Land Use
Reference: Goslee & Urban 2007  
Dissimilarity matrices for composition used the Bray-Curtis distance methoc, as recommended by Goslee & Urban.

First, I test for spatial autocorrelation in composition data; since this is positive, I use partial Mantel tests to test relationships of composition and land use/enviro

```{r Mantel1}
# composition distance matrices
FIAdist <- ecodist::distance(fia[,3:17], method= "bray-curtis") 
PLSdist <- ecodist::distance(pls[,3:17], method= "bray-curtis")

# ----- spatial autocoreelation -----------
spatialDist<- ecodist::distance(centroids[,c('X','Y')], method = "euclidean")
latlongDist <- ecodist::distance(latlong[,c('X','Y')], method = "euclidean")

PLS_space <- mantel(PLSdist ~ spatialDist, nperm=1000)
FIA_space <- mantel(FIAdist ~ spatialDist, nperm=1000)

PLS_space <- mantel(PLSdist ~ latlongDist, nperm=1000)
FIA_space <- mantel(FIAdist ~ latlongDist, nperm=1000)

# yes, data is spatially correlated

# ----- total enviro and land use ------------
luDist <- ecodist::distance(landuse2[,5:14], method = "euclidean")
envirDist <- ecodist::distance(envar2[,5:11], method = "euclidean")

# species vs environment, given effects of space
PLS_env_space <- mantel(PLSdist ~ envirDist + spatialDist, nperm=1000)
FIA_env_space <- mantel(FIAdist ~ envirDist + spatialDist, nperm=1000)

PLS_env_space_ll <- mantel(PLSdist ~ envirDist + latlongDist, nperm=1000)
FIA_env_space_ll <- mantel(FIAdist ~ envirDist + latlongDist, nperm=1000)

PLS_lu_space <- mantel(PLSdist ~ luDist + spatialDist, nperm=1000)
FIA_lu_space <- mantel(FIAdist ~ luDist + spatialDist, nperm=1000)

PLS_lu_space_ll <- mantel(PLSdist ~ luDist + latlongDist, nperm=1000)
FIA_lu_space_ll <- mantel(FIAdist ~ luDist + latlongDist, nperm=1000)
```

These results are quite different from previous results; one thing that changed is the projection of my centroids (used to be lat long, now are projected)

Using lat/long coordinates at 1000 permutations reproduces previous results, more or less















Composition NMDS
----------------------------
Code raw from previous version - not yet updated

```{r}
## NMDS for PLS Data##

#run NMDS
PLS.NMDS<-nmds(PLS.dist, maxdim=2)

#view results for each iteration
PLS.NMDS$stress #1-r^2
PLS.NMDS$r2 #percent variation each configuration explains

# get the NMDS scores for each county for the configuration which had the minimum
#stress values, aka captures the most variance in the data, or has the
# maximum r2 value

PLS.nmds.min<- nmds.min(PLS.NMDS)

#Plot NMDS min stress result
plot(PLS.nmds.min)

#Fit vectors for the main variables to the NMDS configuration
PLS.nmds.vf<- vf(PLS.nmds.min, pls[,4:18], nperm=10) #why 10?
plot(PLS.nmds.vf, col="blue")

## NMDS for FIA Data ##

#run NMDS
FIA.NMDS<-nmds(FIA.dist, maxdim=2)

#view results for each iteration
FIA.NMDS$stress #1-r^2
FIA.NMDS$r2 #percent variation each configuration explains

# get the NMDS scores for each county for the configuration which had the minimum
#stress values, aka captures the most variance in the data, or has the
# maximum r2 value

FIA.nmds.min<- nmds.min(FIA.NMDS)

#Plot NMDS min stress result
plot(FIA.nmds.min)

#Fit vectors for the main variables to the NMDS configuration
FIA.nmds.vf<- vf(PLS.nmds.min, pls[,4:18], nperm=10) #why 10?
plot(FIA.nmds.vf, col="blue")
```

