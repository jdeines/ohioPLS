
```{r options, include=FALSE}
opts_chunk$set(cache = TRUE)
```

Ohio Analyses
========================================================

Jillian Deines  
March 2014

This script analyses correlations among Ohio vegetation (historic and modern) and covariates (land use and environmental variables).

Analyses aim to describe presettlement vegetation in Ohio and examine relationships among
modern vegetation (using FIA data), historic vegetation, land use, and environmental variables.

#### Depends:
This script relies on output from the following scripts
* PLS_FIA_data_crunching.Rmd
* OH_Land_Use_Enviro_Var_processing.Rmd

#### Inputs:
* OHcountyLandCover.csv
* OH_EnviroVarCountySummary.csv
* OH_county_centroids_projected.csv 
* OHCompCleanPLS_percent.csv
* OHCompCleanFIA_percent.csv

#### Crunching:
* 

#### Outputs:
* OHCountyLandCover_aggregated.csv
* 

Working directory and packages
------------------------------
This assumes you have the file 'CleanCodeAndData' set as your working directory

```{r setup,message=FALSE}
setwd('C:/Users/deinesji/Dropbox/Dan_Williams/CleanCodeAndData')
library(ecodist)
library(corrplot)
library(RColorBrewer)
```

Land Use Processing and NMDS
------------------------
Purpose: combine a few land use classes and collapse land use variables into 1 axis for subsequent analysis

### Aggregate Land Use Data 
Chunk already run with intermediate output saved

```{r landUse_agg, eval=FALSE}
# load county land use summary
OHlc<-read.csv("R Output/OHCountyLandCover.csv")

# clean data: combine similar land use classes 
OHlc1 <- cbind(OHlc[,c('Polygon','CountyName','openWater','developedOpen')],
               "developed"=rowSums(OHlc[,c('developedLow','developedMedium',
                                           'developedHigh')]),
                "barren" = OHlc$barren,
                "forest" = rowSums(OHlc[,c('forestDec','forestEver','forestMix')]),
                OHlc[,c('shrub','grassland','pasture','crops')],  
                "wetlands"=rowSums(OHlc[,c('wetlandsWoody','wetlandsHerb')]),
                "numcells" = OHlc$numcells)   

# remove county polygons that have no overlap with land use data (ie, parts of Ottawa county that are islands in Lake Michigan)
OHlc2 <- OHlc1[OHlc1$numcells != 0,]

write.csv(OHlc2,"R Output/OHCountyLandCover_aggregated.csv",row.names=F)
```


Correlations
--------------------------
PLS, FIA, environmental variables, and land use summaries are analyzed for correlations.  
* Proportional species composition data is arc sine square root transformed

**Note:** In previous versions of this script prior to Jill's pre-publication cleaning effort, there was a typo in the land use/composition correlations where the correlation between land use and PLS composition was stored as the variable 'fia.land', and vice versa. **Thus the patterns between land use and composition previously described in Dan's thesis version are reversed**. The number of the correlations differs due to data cleaning, but the pattern of strong/weak and positive/negative correlations is reversed.

```{r Correlations}
setwd('C:/Users/deinesji/Dropbox/Dan_Williams/CleanCodeAndData')

# read in data
pls <- read.csv("R output/OHCompCleanPLS_percent.csv")
fia <- read.csv("R Output/OHCompCleanFIA_percent.csv")
envar <- read.csv("R output/OH_EnviroVarCountySummary.csv")
landuse <- read.csv("R Output/OHCountyLandCover_aggregated.csv")
centroids <- read.csv("R output/OH_county_centroids_projected.csv") 

# subset enviro and land use to 27 data counties, add coords
envar2   <- merge(centroids, envar, by.x = "ID", by.y = "countyID", all.y = FALSE)
landuse2 <- merge(centroids, landuse, by.x = "ID", by.y = "Polygon", all.y = FALSE)

# arcsine squareroot transform proportional data (land use, pls, fia)
pls[,3:17]     <- asin(sqrt(pls[,3:17]))		
fia[,3:17]     <- asin(sqrt(fia[,3:17]))	
landuse2[,5:14] <- asin(sqrt(landuse2[,5:14])) 

# correlations: composition vs enviro, landuse 
plsEnvCor <-cor(envar2[,5:11], pls[,3:17])	
fiaEnvCor <-cor(envar2[,5:11], fia[,3:17])	
#cor(OHenvar3[,3:9], OHenvar3[,11:20])	# environ variables vs land use	
plsLandCor <- cor(landuse2[,5:14], pls[,3:17])	
fiaLandCor <- cor(landuse2[,5:14], fia[,3:17])	
```

### Correlation Plots
Needed: Nicer axis labels, significance indication?
```{r CorrPlots, echo=FALSE}
#pls/environmental variables
corrplot(plsEnvCor, method="color", addCoef.col="black", title="PLS-Enviroment", tl.col="black", 
  col=colorRampPalette(c("darkmagenta", "white", "darkgreen"))(200))
#fia/enviro
corrplot(fiaEnvCor, method="color", addCoef.col="black", title="FIA-Environment", tl.col="black", 
  col=colorRampPalette(c("darkmagenta", "white", "darkgreen"))(200))

#pls/land use
corrplot(plsLandCor, method="color", addCoef.col="black", title="PLS-Land Use", tl.col="black", 
  col=colorRampPalette(c("darkmagenta", "white", "darkorange2"))(200))
#fia/land use
corrplot(fiaLandCor, method="color", addCoef.col="black", title="FIA-Land Use", tl.col="black", 
	col=colorRampPalette(c("darkmagenta", "white", "darkorange2"))(200))
```





### Perform NMDS
### Mantel tests? 1000 permutations seems standard??

```{r landUse_NMDS}
setwd('C:/Users/deinesji/Dropbox/Dan_Williams/CleanCodeAndData')
OHlc3 <- read.csv("R Output/OHCountyLandCover_aggregated.csv")

# arcsine squareroot transform proportional data
OHlc3[,3:12]<- asin(sqrt(OHlc3[,3:12])) 

library(ecodist)		# for NMDS

# calculate distance matrix on land use data columns
OHlcDist <- distance(OHlc3[,3:12], method = "euclidean")

# Run NMDS with only 1 dimension to generate 1 land use value for each county for plotting/correlations:
lcNmds.1 <- nmds(OHlcDist, maxdim = 1)

# View the results for each interation/configurations
lcNmds.1$stress	# can be thought of as 1-r2
lcNmds.1$r2		# Percent variation each configuration explains

# get minimum stress values for each county (to be joined to OHenvar below)
lc.nmds.min.1 <- nmds.min(lcNmds.1)   
lc.nmds.min.1 <- lc.nmds.min.1[,1]    # cheap hack to turn data frame into vector so the column renames correctlyl in the csv output		

```



